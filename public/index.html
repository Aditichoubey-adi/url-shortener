<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piqo Linker</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#007bff">
    <style>
        /* Basic Styling */
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; margin: 0; padding: 10px; text-align: center; }
        .container { max-width: 600px; margin: 20px auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 10px; }
        .input-group { display: flex; flex-direction: column; gap: 12px; align-items: center; width: 100%; }
        
        input { padding: 15px; border: 2px solid #eee; border-radius: 12px; font-size: 16px; width: 100%; box-sizing: border-box; }
        button { padding: 15px; width: 100%; background: #007bff; color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #0056b3; }

        #result-box { margin-top: 20px; padding: 15px; background: #d4edda; color: #155724; border-radius: 12px; display: none; word-break: break-all; }

        /* Mobile Responsive Table to Cards */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { display: none; } 
        tr { display: block; background: #fafafa; margin-bottom: 15px; padding: 15px; border-radius: 15px; border: 1px solid #eee; text-align: left; }
        td { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        td:last-child { border-bottom: none; justify-content: center; margin-top: 10px; }
        td::before { content: attr(data-label); font-weight: bold; color: #888; }

        .short-url { color: #007bff; font-weight: bold; text-decoration: none; }

        @media (min-width: 600px) {
            body { padding: 40px; }
            .input-group { flex-direction: row; }
            button { width: 30%; }
            tr { display: table-row; background: none; }
            td { display: table-cell; border-bottom: 1px solid #eee; padding: 12px; }
            th { display: table-cell; background: #f8f9fa; padding: 12px; }
            td::before { content: none; }
        }
    </style>
</head>
<body>

<div class="header" style="max-width: 600px; margin: auto;">
    <span style="font-size: 24px; cursor: pointer;" onclick="location.reload()"> Home</span>
    <h1 style="margin: 0; font-size: 22px;">Piqo Linker</h1>
    <span style="font-size: 24px; cursor: pointer;" onclick="shareApp()">ðŸ“¤</span>
</div>

<div class="container">
    <p>Paste your long URL below</p>
    <div class="input-group">
        <input type="text" id="longUrl" placeholder="https://example.com/very-long-link">
        <button onclick="shortenUrl()">Shorten</button>
    </div>

    <div id="result-box"></div>

    <h2 style="margin-top: 30px;">Live Analytics</h2>
    <table>
        <tbody id="linkTable">
            </tbody>
    </table>

    <button onclick="clearHistory()" style="background:#ff4757; margin-top: 20px; width: auto; padding: 10px 20px; font-size: 14px;">
         Clear All History
    </button>
</div>

<script>
    async function shortenUrl() {
        const urlInput = document.getElementById('longUrl');
        const resultBox = document.getElementById('result-box');
        if (!urlInput.value) return alert("Please enter URL!");

        const response = await fetch('/shorten', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ longUrl: urlInput.value })
        });
        const data = await response.json();
        if (data.shortUrl) {
            resultBox.style.display = "block";
            resultBox.innerHTML = `Success! link: <a href="${data.shortUrl}" target="_blank" class="short-url">${data.shortUrl}</a>`;
            urlInput.value = "";
            fetchTableData();
        }
    }

    async function fetchTableData() {
        try {
            const response = await fetch('/all-links');
            const links = await response.json();
            const tableBody = document.getElementById('linkTable');
            
            tableBody.innerHTML = links.map(link => `
                <tr>
                    <td data-label="Original" style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${link.longUrl}</td>
                    <td data-label="Short Link">
                        <a href="/${link.shortId}" target="_blank" class="short-url">/${link.shortId}</a>
                    </td>
                    <td data-label="Clicks">${link.clicks || 0}</td>
                    <td data-label="Action">
                        <button onclick="shareLink('${link.shortId}')" style="padding: 5px 15px; background:#28a745; width: auto;">Share</button>
                    </td>
                </tr>
            `).join('');
        } catch (err) {
            console.error("Data missing", err);
        }
    }

    function shareLink(shortId) {
        const fullUrl = `https://url-shortener-piqo.onrender.com/${shortId}`;
        if (navigator.share) {
            navigator.share({ title: 'Short Link', url: fullUrl });
        } else {
            alert("Link copied: " + fullUrl);
            navigator.clipboard.writeText(fullUrl);
        }
    }

    async function clearHistory() {
        if(confirm("Delete all history?")) {
            await fetch('/clear-all', { method: 'DELETE' });
            fetchTableData();
        }
    }

    function shareApp() {
        if (navigator.share) {
            navigator.share({
                title: 'Piqo Linker',
                text: 'Check out this cool URL Shortener App!',
                url: 'https://url-shortener-piqo.onrender.com'
            });
        } else {
            alert("App Link: https://url-shortener-piqo.onrender.com");
        }
    }

    fetchTableData();
    setInterval(fetchTableData, 5000);

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js');
        });
    }
</script>
</body>
</html>